<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ‚Äî QuizPro Winner</title>
    <link rel="manifest" href="/manifest.json?v=1.3" />
    <link href="https://fonts.cdnfonts.com/css/monster-clubhouse" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css?v=1.3" />

    <style>
        .tab-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 22px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-family: var(--font);
            font-weight: 600;
            font-size: .88rem;
            cursor: pointer;
            transition: all .2s;
        }

        .tab-btn:hover {
            border-color: var(--blue);
            color: var(--text);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--blue), var(--indigo));
            border-color: transparent;
            color: #fff;
        }

        .session-card {
            position: relative;
        }

        .session-card .fee {
            font-size: 1.5rem;
            font-weight: 900;
        }

        .session-card .s-title {
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .session-card .s-meta {
            font-size: .82rem;
            color: var(--muted);
            margin-bottom: 14px;
        }

        .session-card .seat-row {
            margin: 14px 0;
        }

        .session-card .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 14px;
        }

        /* countdown badge */
        .time-badge {
            font-size: .78rem;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(245, 158, 11, .12);
            color: var(--gold);
            border: 1px solid rgba(245, 158, 11, .25);
            display: inline-block;
            margin-top: 8px;
        }

        .wallet-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .wallet-chip {
            flex: 1;
            min-width: 140px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 18px;
        }

        .wallet-chip .wlabel {
            font-size: .75rem;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .wallet-chip .wamt {
            font-size: 1.6rem;
            font-weight: 900;
        }

        .wallet-chip .wamt.demo {
            color: #60a5fa;
        }

        .wallet-chip .wamt.real {
            color: #10b981;
        }

        .ref-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 18px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .ref-code {
            font-size: 1.4rem;
            font-weight: 900;
            letter-spacing: 4px;
            color: var(--gold);
            font-family: monospace;
        }

        .txn-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, .05);
            font-size: .85rem;
        }

        .txn-cr {
            color: #10b981;
            font-weight: 700;
        }

        .txn-dr {
            color: #ef4444;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <style>
        .balance-hidden {
            filter: blur(8px);
            cursor: pointer;
        }
    </style>



    <!-- NAVBAR -->
    <nav class="navbar deep-glass">
        <a href="/" class="logo" style="font-size: 1.3rem;">üíé QuizPro Winner</a>

        <div class="nav-links">
            <!-- QUICK WALLET CHIP -->
            <a href="/wallet.html" id="quickWallet" class="glass-card"
                style="padding: 6px 14px; border-radius: 20px; display: flex; align-items: center; gap: 8px; text-decoration: none; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05);">
                <span style="font-size: 1rem;">üí∞</span>
                <span id="navBal" style="font-size: .9rem; font-weight: 800; color: var(--green);">‚Çπ0</span>
            </a>
            <span id="userGreet" style="color:var(--muted); font-size:.88rem; font-weight: 500;"></span>
            <a href="/dashboard.html" class="active" style="color: var(--blue);">Dashboard</a>
            <a href="/wallet.html"
                style="color: var(--muted); text-decoration: none; font-size: .88rem; font-weight: 500;">Wallet</a>
            <button class="btn btn-outline" style="padding:6px 16px; font-size:.85rem; border-radius: 12px;"
                onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- MOBILE BOTTOM NAV -->
    <div class="bottom-nav">
        <a href="/dashboard.html" class="nav-item active">
            <i style="font-style: normal; font-size: 1.6rem;">üè†</i>
            <span>Home</span>
            <div class="icon-dot"></div>
        </a>
        <!-- WALLET NAV DIRECT LINK -->
        <a href="/wallet.html" class="nav-item">
            <i style="font-style: normal; font-size: 1.6rem;">üí≥</i>
            <span>Wallet</span>
            <div class="icon-dot"></div>
        </a>
        <a href="/leaderboard.html" class="nav-item">
            <i style="font-style: normal; font-size: 1.6rem;">üèÜ</i>
            <span>Ranks</span>
            <div class="icon-dot"></div>
        </a>
        <button onclick="logout()" class="nav-item"
            style="background:none; border:none; padding:0; font-family:inherit;">
            <i style="font-style: normal; font-size: 1.6rem;">üö™</i>
            <span>Logout</span>
            <div class="icon-dot"></div>
        </button>
    </div>

    <div class="main">
        <div class="container" style="padding-top:40px;">

            <!-- PRO TIP BANNER -->
            <div class="glass-card"
                style="padding: 14px 24px; border-radius: 16px; margin-bottom: 24px; background: rgba(59, 130, 246, 0.05); border: 1px dashed var(--blue); display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.2rem;">üí°</span>
                <span style="font-size: .88rem; color: var(--blue); font-weight: 600;">PRO TIP: Get study material 30
                    mins before Live Quiz.</span>
            </div>

            <div class="page-hero">
                <h1 class="text-gold-luxury font-monster" style="font-size: 3.5rem;">Elite Dashboard</h1>
                <p style="letter-spacing: 1px; color: var(--gold); font-weight: 600;">Welcome to the VIP arena. Play,
                    Win, and Repeat.</p>
            </div>

            <!-- BENTO HEADER GRID -->
            <div class="grid-2" style="margin-bottom: 32px; gap: 24px;">
                <!-- PERFORMANCE MASTERY CARD -->
                <div class="glass-card deep-glass"
                    style="border-radius: var(--radius-md); padding: 28px; border-left: 5px solid var(--violet); position: relative; overflow: hidden; background: linear-gradient(145deg, rgba(139, 92, 246, 0.05), rgba(15, 23, 42, 0.4));">
                    <div
                        style="font-size: .7rem; color: var(--violet); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px;">
                        Global Performance</div>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div
                            style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--violet), var(--indigo)); display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);">
                            üíé</div>
                        <div>
                            <div style="font-size: 1.8rem; font-weight: 900; color: #fff;">Legend Rank</div>
                            <div style="font-size: .82rem; color: var(--muted); margin-top: 4px;">Top 2% Globally ‚Ä¢
                                Elite Status</div>
                        </div>
                    </div>

                    <div style="margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div
                            style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 14px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: .65rem; color: var(--muted); margin-bottom: 4px;">WIN STREAK</div>
                            <div style="font-size: 1.1rem; font-weight: 900; color: var(--gold);">üî• 12 DAYS</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 14px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: .65rem; color: var(--muted); margin-bottom: 4px;">ACCURACY</div>
                            <div style="font-size: 1.1rem; font-weight: 900; color: var(--green);">94.8%</div>
                        </div>
                    </div>
                </div>


                <!-- QUICK ACTIONS CARD -->
                <div class="glass-card deep-glass"
                    style="border-radius: var(--radius-md); padding: 28px; display: flex; flex-direction: column; gap: 12px; justify-content: center; background: linear-gradient(145deg, rgba(59, 130, 246, 0.05), rgba(15, 23, 42, 0.4));">
                    <div
                        style="font-size: .7rem; color: var(--blue); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px;">
                        Quick Operations</div>
                    <button class="btn btn-primary btn-full"
                        style="border-radius: 16px; padding: 16px; font-weight: 800; font-size: 1rem; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.25);"
                        onclick="window.location='/wallet.html'">
                        ‚ö° Add Instant Funds
                    </button>
                    <button class="btn btn-outline btn-full"
                        style="border-radius: 16px; padding: 16px; font-size: .9rem; border-color: rgba(255,255,255,0.1);"
                        onclick="window.location='/leaderboard.html'">
                        üèÜ View Global Rankings
                    </button>
                </div>
            </div>

            <!-- REFERRAL BOX (Luxury Style) -->
            <div class="glass-card deep-glass"
                style="border-radius: var(--radius-md); padding: 24px; margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; border-left: 4px solid var(--gold);">
                <div>
                    <div
                        style="font-size: .7rem; color: var(--gold); font-weight: 700; letter-spacing: 1px; margin-bottom: 4px;">
                        EXCLUSIVE INVITE PROGRAM</div>
                    <div style="font-size: 1.6rem; font-weight: 900; letter-spacing: 2px; font-family: monospace;"
                        id="refCode">...</div>
                    <p style="font-size: .75rem; color: var(--muted); margin-top: 4px;">Earn 10% bonus for every friend
                        you bring.</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" style="border-radius: 12px; padding: 10px 20px; font-size: .8rem;"
                        onclick="copyRef()">Copy Link</button>
                    <button class="btn btn-gold" style="border-radius: 12px; padding: 10px 20px; font-size: .8rem;"
                        onclick="shareRef()">Share Now</button>
                </div>
            </div>

            <!-- TAB NAVIGATION -->
            <div class="tab-bar" style="margin-bottom: 32px;">
                <button class="tab-btn active" data-cat="all" onclick="filterSessions('all', this)">All
                    Arenas</button>
                <button class="tab-btn" data-cat="1" onclick="filterSessions('1', this)">üü¢ Rookie</button>
                <button class="tab-btn" data-cat="2" onclick="filterSessions('2', this)">üü° Sharp</button>
                <button class="tab-btn" data-cat="3" onclick="filterSessions('3', this)">üî¥ Legend</button>
            </div>

            <div id="sessionsGrid" class="grid-3" style="align-items:start; gap: 24px;"></div>
            <div id="loadingState" class="empty-state">
                <div class="spinner"></div>
                <p>Loading sessions...</p>
            </div>
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="icon">üéØ</div>
                <p>No active sessions right now.<br>Check back soon or ask admin to create one.</p>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <script src="/js/common.js?v=1.3"></script>

    <script>
        requireLogin();
        let allSessions = [];
        const user = getUser();
        if (user) {
            document.getElementById('userGreet').textContent = `üë§ ${user.email}`;
        }


        function toggleWallet() {
            const amt = document.getElementById('realAmt');
            const tap = document.getElementById('tapToShow');
            if (amt.classList.contains('balance-hidden')) {
                amt.classList.remove('balance-hidden');
                tap.textContent = 'üîí CLICK TO HIDE';
                tap.style.color = 'var(--muted)';
            } else {
                amt.classList.add('balance-hidden');
                tap.textContent = 'üéØ CLICK TO REVEAL';
                tap.style.color = 'var(--blue)';
            }
        }

        // Load wallet
        async function loadWallet() {
            try {
                const w = await api('/api/wallet/me');
                if (document.getElementById('navBal')) document.getElementById('navBal').textContent = '‚Çπ' + (w.real || 0);
            } catch (e) { }
        }

        // Load referral code
        async function loadProfile() {
            try {
                const me = await api('/api/auth/me');
                document.getElementById('refCode').textContent = me.referral_code || 'N/A';
                if (user) document.getElementById('userGreet').textContent = `üë§ ${me.name || me.email}`;
            } catch (e) { }
        }

        function copyRef() {
            const code = document.getElementById('refCode').textContent;
            const link = `${location.origin}/login.html?ref=${code}`;
            navigator.clipboard.writeText(link).then(() => toast('üîó Referral link copied!', 'success')).catch(() => toast(code, 'info'));
        }

        function shareRef() {
            const code = document.getElementById('refCode').textContent;
            const link = `${location.origin}/login.html?ref=${code}`;
            const txt = `üéØ QuizPro pe join karo!\nMera referral code use karo: ${code}\n${link}`;
            if (navigator.share) navigator.share({ title: 'QuizPro Referral', text: txt, url: link });
            else { navigator.clipboard.writeText(txt); toast('Share message copied!', 'success'); }
        }

        async function showTxns() {
            document.getElementById('txnModal').style.display = 'flex';
            try {
                const txns = await api('/api/wallet/txns');
                document.getElementById('txnList').innerHTML = txns.length ? txns.map(t => `
                    <div class="txn-row">
                        <div>
                            <div>${t.note}</div>
                            <div style="font-size:.7rem;color:var(--muted);">${t.wallet === 'real' ? 'üíµ Real' : ''} ‚Ä¢ ${new Date(t.at * 1000).toLocaleDateString()}</div>
                        </div>
                        <div class="txn-${t.type === 'credit' ? 'cr' : 'dr'}">${t.type === 'credit' ? '+' : '-'}‚Çπ${t.amount}</div>
                    </div>`).join('') : '<p style="text-align:center;color:var(--muted);">No transactions yet</p>';
            } catch (e) { document.getElementById('txnList').innerHTML = 'Error loading'; }
        }

        loadWallet();
        loadProfile();

        // Load badges
        async function loadBadges() {
            try {
                const badges = await api('/api/auth/badges');
                if (!badges.length) return;
                document.getElementById('badgeSection').style.display = 'block';
                document.getElementById('badgeList').innerHTML = badges.map(b => `
                    <div title="${b.desc}" style="background:rgba(124,58,237,.15);border:1px solid rgba(124,58,237,.3);border-radius:12px;padding:8px 14px;display:flex;align-items:center;gap:6px;cursor:default;">
                        <span style="font-size:1.3rem;">${b.icon}</span>
                        <span style="font-size:.78rem;font-weight:700;color:var(--text);">${b.name}</span>
                    </div>`).join('');
            } catch (e) { }
        }
        loadBadges();

        async function loadSessions() {
            try {
                allSessions = await api('/api/sessions');
                renderSessions(allSessions);
            } catch (e) {
                document.getElementById('sessionsGrid').innerHTML =
                    `<div style="color:var(--muted);text-align:center;padding:40px;grid-column:1/-1;">
                        <div style="font-size:2rem;margin-bottom:8px;">‚ö†Ô∏è</div>
                        <div>Sessions load nahi hue.</div>
                        <div style="font-size:.8rem;margin-top:6px;">${e.message}</div>
                        <button class="btn btn-outline" style="margin-top:14px;" onclick="loadSessions()">üîÑ Retry</button>
                    </div>`;
            } finally {
                hideLoading('loadingState'); // ALWAYS hide spinner
            }
        }

        function filterSessions(catId, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filtered = catId === 'all' ? allSessions : allSessions.filter(s => s.category_id == catId);
            renderSessions(filtered);
        }

        function renderSessions(sessions) {
            const grid = document.getElementById('sessionsGrid');
            const empty = document.getElementById('emptyState');
            if (!sessions.length) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            const statusMap = {
                open: { label: 'Open', cls: 'badge-blue' },
                confirmed: { label: 'Confirmed ‚úÖ', cls: 'badge-green' },
                live: { label: '‚ö° QUIZ STARTED', cls: 'badge-red' },
                completed: { label: 'Completed', cls: 'badge-violet' },
                cancelled: { label: 'Cancelled', cls: 'badge-red' }
            };
            grid.innerHTML = sessions.map(s => {
                const pct = Math.round((s.seats_booked / s.seat_limit) * 100);
                const st = statusMap[s.status] || { label: s.status, cls: 'badge-blue' };
                const seatsLeft = s.seat_limit - s.seats_booked;
                let timeInfo = '';
                if (s.quiz_start_at) {
                    const diff = s.quiz_start_at - Math.floor(Date.now() / 1000);
                    if (diff > 0) timeInfo = `<div class="time-badge" style="border-radius:10px; background:rgba(251,191,36,0.1); border-color:var(--gold-glow)">‚è∞ ${formatCountdown(diff)}</div>`;
                }
                return `
        <div class="glass-card session-card" style="border-radius: 24px; padding: 24px; cursor: pointer;" onclick="window.location='/session.html?id=${s.id}'">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 16px;">
            <span class="badge ${st.cls}" style="border-radius: 8px; padding: 6px 12px; font-size: 0.7rem;">${st.label}</span>
            <div style="font-size: 1.2rem;">üíé</div>
          </div>
          <div class="s-title" style="font-size: 1.2rem; margin-bottom: 4px; color: #fff;">${s.title}</div>
          <div class="s-meta" style="font-size: .8rem; margin-bottom: 12px; opacity: 0.6;">${s.category_name} ‚Ä¢ ${s.seat_limit} Arena</div>
          
          <div style="background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; margin: 16px 0; border: 1px solid rgba(255,255,255,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                <div class="fee" style="color:var(--gold); font-size: 1.8rem; margin:0; filter: drop-shadow(0 0 10px rgba(251,191,36,0.3))">‚Çπ${s.entry_fee}</div>
                <div style="text-align:right;">
                    <div style="font-size: .7rem; color: var(--green); font-weight: 700; letter-spacing: 1px;">TOTAL PRIZE</div>
                    <div style="font-size: 1.2rem; color: #fff; font-weight: 900;">‚Çπ${Math.floor(s.entry_fee * s.seat_limit * 0.75).toLocaleString()}</div>
                </div>
            </div>
            
            <!-- RANK BREAKDOWN -->
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <div style="text-align:center;">
                    <div style="font-size: .65rem; color: var(--gold); font-weight: 800; margin-bottom: 4px;">ü•á 1ST</div>
                    <div style="font-size: 1rem; color: #fff; font-weight: 900;">‚Çπ${Math.floor(s.entry_fee * s.seat_limit * 0.75 * 0.25).toLocaleString()}</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size: .65rem; color: #e2e8f0; font-weight: 800; margin-bottom: 4px;">ü•à 2ND</div>
                    <div style="font-size: 1rem; color: #fff; font-weight: 900;">‚Çπ${Math.floor(s.entry_fee * s.seat_limit * 0.75 * 0.15).toLocaleString()}</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size: .65rem; color: #f59e0b; font-weight: 800; margin-bottom: 4px;">ü•â 3RD</div>
                    <div style="font-size: 1rem; color: #fff; font-weight: 900;">‚Çπ${Math.floor(s.entry_fee * s.seat_limit * 0.75 * 0.11).toLocaleString()}</div>
                </div>
            </div>
          </div>

          <div class="seat-row" style="margin-bottom: 20px;">
            <div class="seat-label" style="margin-bottom: 8px; display:flex; justify-content:space-between; font-size: 0.75rem;">
                <span style="color: #fff; font-weight: 600;">${s.seats_booked}/${s.seat_limit} Booked</span>
                <span style="color: var(--muted);">${seatsLeft} Spot Left</span>
            </div>
            <div class="progress-wrap" style="height: 6px; background: rgba(255,255,255,0.05);">
                <div class="progress-fill" style="width:${pct}%; background: linear-gradient(90deg, var(--blue), var(--violet)); box-shadow: 0 0 10px var(--blue);"></div>
            </div>
          </div>
          
          ${timeInfo}
          
          <div style="display:flex; gap:10px; margin-top:16px;">
            ${s.status === 'live'
                        ? `<a href="/quiz.html?id=${s.id}" class="btn btn-gold" style="flex:1; border-radius: 12px; font-weight:800; animation: pulse 2s infinite;">üî• JOIN ARENA</a>`
                        : `<button class="btn btn-primary" style="flex:1; border-radius: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59,130,246,0.3); color: var(--blue);">Enter Lobby ‚Üí</button>`
                    }
          </div>
        </div>`;
            }).join('');
        }

        async function quickUpload(sid) {
            let input = document.getElementById('quickExcelInput');
            if (!input) {
                input = document.createElement('input');
                input.type = 'file';
                input.id = 'quickExcelInput';
                input.style.display = 'none';
                input.accept = '.xlsx,.xls';
                document.body.appendChild(input);
            }
            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', sid);

                toast('üì§ Uploading questions...', 'info');
                try {
                    const res = await fetch('/api/admin/questions/upload', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + getToken() },
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error);
                    toast('‚úÖ ' + data.message, 'success');
                } catch (e) {
                    toast('‚ùå ' + e.message, 'error');
                }
                input.value = '';
            };
            input.click();
        }

        function formatCountdown(sec) {
            const m = Math.floor(sec / 60), s = sec % 60;
            return `${m}m ${s}s`;
        }

        function logout() { localStorage.clear(); window.location.href = '/login.html'; }

        loadSessions();
        renderFooter();
        // Auto-refresh every 30 seconds
        setInterval(loadSessions, 30000);
    </script>
</body>

</html>