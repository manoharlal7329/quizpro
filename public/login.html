<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login ‚Äî QuizPro</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-wrap {
            width: 100%;
            max-width: 420px;
            padding: 24px;
        }

        .login-logo {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--blue), var(--violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 32px;
        }

        .otp-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 16px 0;
        }

        .otp-inputs input {
            width: 44px;
            height: 50px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            border-radius: 12px;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
            color: var(--muted);
            font-size: .88rem;
            cursor: pointer;
        }

        .back-link span {
            color: var(--blue);
            cursor: pointer;
        }

        #step2 {
            display: none;
        }

        .otp-hint {
            text-align: center;
            font-size: .82rem;
            color: var(--muted);
            margin-bottom: 16px;
        }

        .otp-hint strong {
            color: var(--gold);
        }
    </style>
</head>

<body>
    <div class="login-wrap">
        <div class="login-logo">‚ö° QuizPro</div>

        <!-- STEP 1: Mobile -->
        <div id="step1" class="card">
            <h2 style="font-size:1.4rem; font-weight:800; margin-bottom:6px;">Welcome Back üëã</h2>
            <p style="color:var(--muted); font-size:.9rem; margin-bottom:24px;">Enter your mobile number to continue</p>
            <div id="alertBox"></div>
            <div class="form-group">
                <label>üì± Mobile Number</label>
                <input type="tel" id="mobileInput" placeholder="Enter 10-digit mobile number" maxlength="10" />
            </div>
            <button class="btn btn-primary btn-full" id="sendOtpBtn" onclick="sendOtp()">Send OTP</button>
            <p style="text-align:center; margin-top:16px; font-size:.8rem; color:var(--muted);">
                New user? Account is created automatically on first login.
            </p>
        </div>

        <!-- STEP 2: OTP -->
        <div id="step2" class="card">
            <h2 style="font-size:1.4rem; font-weight:800; margin-bottom:6px;">Enter OTP üîê</h2>
            <p style="color:var(--muted); font-size:.9rem; margin-bottom:8px;">OTP sent to <strong
                    id="mobileDisplay"></strong></p>
            <div id="alertBox2"></div>
            <div id="otpHintBox"
                style="display:none; text-align:center; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.3); border-radius:10px; padding:12px; margin-bottom:12px;">
                <div style="font-size:.75rem; color:var(--muted); margin-bottom:4px;">Your OTP</div>
                <div id="otpDisplay" style="font-size:2rem; font-weight:900; color:var(--gold); letter-spacing:8px;">
                </div>
                <div style="font-size:.7rem; color:var(--muted); margin-top:4px;">Enter this OTP below ‚Üì</div>
            </div>
            <div class="otp-inputs">
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
                <input type="text" class="otp-digit" maxlength="1" inputmode="numeric" />
            </div>
            <button class="btn btn-success btn-full" id="verifyOtpBtn" onclick="verifyOtp()">Verify OTP & Login</button>
            <p class="back-link">Wrong number? <span onclick="goBack()">Go back</span></p>
        </div>
    </div>

    <div id="toast"></div>
    <script src="/js/common.js"></script>
    <script>
        let mobile = '';
        // Capture referral code from URL (?ref=CODE)
        const _refCode = new URLSearchParams(location.search).get('ref') || '';
        if (_refCode) {
            document.getElementById('step1').insertAdjacentHTML('afterbegin', `
                <div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:.82rem;">
                    üéÅ Referral code <strong style="color:var(--gold);">${_refCode}</strong> detect hua ‚Äî register karo aur ‚Çπ100 free demo bonus pao!
                </div>`);
        };

        // OTP digit auto-focus
        document.querySelectorAll('.otp-digit').forEach((inp, i, all) => {
            inp.addEventListener('input', () => { if (inp.value && i < all.length - 1) all[i + 1].focus(); });
            inp.addEventListener('keydown', e => { if (e.key === 'Backspace' && !inp.value && i > 0) all[i - 1].focus(); });
        });

        async function sendOtp() {
            mobile = document.getElementById('mobileInput').value.trim();
            if (!/^\d{10}$/.test(mobile)) { showAlert('alertBox', 'Enter valid 10-digit mobile number', 'error'); return; }
            setBtnLoading('sendOtpBtn', true);
            try {
                const r = await api('/api/auth/send-otp', 'POST', { mobile, ref_code: _refCode });
                document.getElementById('mobileDisplay').textContent = mobile;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                // Show OTP on screen (SMS provider not integrated)
                if (r.otp) {
                    document.getElementById('otpHintBox').style.display = 'block';
                    document.getElementById('otpDisplay').textContent = r.otp;
                    // Auto-fill OTP digits
                    const digits = document.querySelectorAll('.otp-digit');
                    [...r.otp].forEach((d, i) => { if (digits[i]) digits[i].value = d; });
                }
                document.querySelectorAll('.otp-digit')[0].focus();
                toast('OTP generated! Enter it below.', 'success');
            } catch (e) {
                showAlert('alertBox', e.message, 'error');
            }
            setBtnLoading('sendOtpBtn', false);
        }

        async function verifyOtp() {
            const otp = [...document.querySelectorAll('.otp-digit')].map(i => i.value).join('');
            if (otp.length !== 6) { showAlert('alertBox2', 'Enter the 6-digit OTP', 'error'); return; }
            setBtnLoading('verifyOtpBtn', true);
            try {
                const r = await api('/api/auth/verify-otp', 'POST', { mobile, otp });
                localStorage.setItem('token', r.token);
                localStorage.setItem('user', JSON.stringify(r.user));
                toast('Login successful! Redirecting...', 'success');
                setTimeout(() => { window.location.href = r.user.is_admin ? '/admin.html' : '/dashboard.html'; }, 1000);
            } catch (e) {
                showAlert('alertBox2', e.message, 'error');
            }
            setBtnLoading('verifyOtpBtn', false);
        }

        function goBack() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
        }

        function showAlert(id, msg, type) {
            document.getElementById(id).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        }

        function setBtnLoading(id, loading) {
            const btn = document.getElementById(id);
            btn.disabled = loading;
            btn.textContent = loading ? 'Please wait...' : (id === 'sendOtpBtn' ? 'Send OTP' : 'Verify OTP & Login');
        }

        // If already logged in, redirect
        if (localStorage.getItem('token')) window.location.href = '/dashboard.html';
    </script>
</body>

</html>