<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Results ‚Äî QuizPro Winner</title>
    <link rel="stylesheet" href="/css/style.css?v=1.1" />

    <style>
        .podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            margin: 32px 0;
        }

        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .podium-block {
            width: 110px;
            border-radius: 14px 14px 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px 10px;
            font-size: .85rem;
            font-weight: 700;
        }

        .p1 {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #000;
            height: 140px;
        }

        .p2 {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: #fff;
            height: 110px;
        }

        .p3 {
            background: linear-gradient(135deg, #b45309, #92400e);
            color: #fff;
            height: 90px;
        }

        .podium-avatar {
            font-size: 2rem;
        }

        .podium-name {
            font-size: .78rem;
            margin-top: 4px;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .podium-prize {
            font-size: .9rem;
            font-weight: 800;
        }

        .result-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            margin-bottom: 8px;
        }

        .result-row.mine {
            border-color: var(--blue);
            background: rgba(14, 165, 233, .06);
        }

        .rank-num {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: .9rem;
            flex-shrink: 0;
        }

        .score-info {
            font-size: .82rem;
            color: var(--muted);
        }

        .prize-badge {
            margin-left: auto;
            font-weight: 700;
            color: var(--gold);
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="/dashboard.html" class="logo">‚ö° QuizPro Winner</a>

        <div class="nav-links">
            <a href="/dashboard.html" class="btn btn-outline" style="padding:8px 18px; font-size:.85rem;">‚Üê
                Dashboard</a>
        </div>
    </nav>

    <div class="main">
        <div class="container" style="padding-top:40px; max-width:760px;">
            <div id="loadingState" style="text-align:center; padding:80px;">
                <div class="spinner"></div>
            </div>
            <div id="content" style="display:none;">
                <div style="text-align:center; margin-bottom:32px;">
                    <div style="font-size:3rem; margin-bottom:8px;" id="resultEmoji">üèÜ</div>
                    <h1 style="font-size:1.8rem; font-weight:800;" id="resultTitle">Quiz Results</h1>
                    <p style="color:var(--muted); margin-top:6px;" id="resultSub"></p>
                </div>

                <div id="prizeInfo" class="card" style="margin-bottom:28px; text-align:center;"></div>

                <div style="display:flex; gap:12px; margin-bottom:28px;">
                    <button id="viewBreakdownBtn" class="btn btn-outline" style="flex:1; display:none;"
                        onclick="toggleBreakdown()">‚ö° View Detailed Result</button>
                    <button class="btn btn-primary" style="flex:1;" onclick="showPayoutInfo()">üí∞ Payout Status</button>
                </div>

                <!-- PERSONAL SPEED BREAKDOWN (Hidden by Default) -->
                <div id="personalBreakdown" class="card"
                    style="margin-bottom:28px; display:none; border-color:var(--blue); background:rgba(14,165,233,.03);">
                    <h3 style="font-size:1.05rem; font-weight:700; margin-bottom:12px;">‚ö° Your Speed Breakdown</h3>
                    <div style="display:flex; gap:16px; margin-bottom:16px;">
                        <div
                            style="flex:1; background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; text-align:center;">
                            <div style="font-size:.75rem; color:var(--muted); margin-bottom:4px;">Total Time</div>
                            <div style="font-size:1.1rem; font-weight:800; color:var(--blue);" id="totalMs">0 ms</div>
                        </div>
                        <div
                            style="flex:1; background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; text-align:center;">
                            <div style="font-size:.75rem; color:var(--muted); margin-bottom:4px;">Avg Speed</div>
                            <div style="font-size:1.1rem; font-weight:800; color:var(--green);" id="avgMs">0 ms</div>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; font-size:.8rem;">
                            <thead>
                                <tr style="color:var(--muted); border-bottom:1px solid var(--border);">
                                    <th style="padding:8px 10px;">Q</th>
                                    <th style="padding:8px 10px;">Your Ans</th>
                                    <th style="padding:8px 10px;">Status</th>
                                    <th style="padding:8px 10px; text-align:right;">Time (ms)</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownBody"></tbody>
                        </table>
                    </div>
                    <p style="font-size:.72rem; color:var(--muted); margin-top:12px; text-align:center;">
                        üéØ <strong>Rule:</strong> Rank is decided by Correct Answers first, then Total Milliseconds.
                    </p>
                </div>

                <div id="podiumWrap"></div>
                <h3 style="font-size:1.05rem; font-weight:700; margin-bottom:16px;">üìã Full Leaderboard</h3>
                <div id="leaderboard"></div>
            </div>

            <!-- Payout Popup -->
            <div id="payoutModal" class="modal-overlay" style="display:none;">
                <div class="modal-box" style="text-align:center;">
                    <div style="font-size:3rem; margin-bottom:8px;">üí∞</div>
                    <h3>Payout Status</h3>
                    <div id="payoutDetails"
                        style="margin:20px 0; padding:16px; background:rgba(255,255,255,.03); border-radius:12px; border:1px solid var(--border);">
                        <!-- Dynamic Content -->
                    </div>
                    <button class="btn btn-primary btn-full"
                        onclick="document.getElementById('payoutModal').style.display='none'">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <script src="/js/common.js?v=1.1"></script>

    <script>
        requireLogin();
        const params = new URLSearchParams(location.search);
        const sessId = params.get('id');
        const user = getUser();
        let globalData = null;

        async function load() {
            try {
                const data = await api(`/api/results/${sessId}`);
                globalData = data;
                document.getElementById('content').style.display = 'block';
                render(data);
            } catch (e) {
                document.getElementById('loadingState').innerHTML =
                    `<div style="text-align:center;padding:40px;">
                        <div style="font-size:2rem;margin-bottom:8px;">‚ö†Ô∏è</div>
                        <p style="color:var(--muted);">${e.message}</p>
                        <button class="btn btn-outline" onclick="load()" style="margin-top:12px;">üîÑ Retry</button>
                    </div>`;
            } finally {
                hideLoading('loadingState');
            }
        }

        function toggleBreakdown() {
            const el = document.getElementById('personalBreakdown');
            const btn = document.getElementById('viewBreakdownBtn');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                btn.textContent = '‚ö° Hide Detailed Result';
                el.scrollIntoView({ behavior: 'smooth' });
            } else {
                el.style.display = 'none';
                btn.textContent = '‚ö° View Detailed Result';
            }
        }

        function showPayoutInfo() {
            const { session, results, prizes } = globalData;
            const myResult = results.find(r => user && r.user_id == user.id);
            const myPrize = prizes.find(p => p.rank === myResult?.rank);

            const detailsEl = document.getElementById('payoutDetails');
            if (!myResult) {
                detailsEl.innerHTML = `<p style="color:var(--muted);">You didn't participate in this session.</p>`;
            } else if (!myPrize) {
                detailsEl.innerHTML = `
                    <p style="color:var(--muted);">Better luck next time!</p>
                    <div style="margin-top:12px; font-weight:700;">Rank #${myResult.rank}</div>
                    <div style="color:var(--red); font-size:.8rem; margin-top:4px;">(Only Top 10 are paid)</div>`;
            } else {
                detailsEl.innerHTML = `
                    <div style="font-size:1.5rem; font-weight:900; color:var(--gold); margin-bottom:4px;">‚Çπ${myPrize.amount}</div>
                    <div style="font-size:.78rem; color:var(--muted);">Winning Prize (Rank #${myResult.rank})</div>
                    <hr style="margin:16px 0; opacity:.1;">
                    <div style="text-align:left;">
                        <div style="font-size:.75rem; color:var(--muted);">Status</div>
                        <div style="font-weight:700; color:var(--green);">PROCESSING</div>
                        <div style="font-size:.75rem; color:var(--muted); margin-top:8px;">Timeline</div>
                        <div style="font-size:.8rem;">Will be sent to your UPI ID within 2‚Äì4 hours.</div>
                    </div>`;
            }
            document.getElementById('payoutModal').style.display = 'flex';
        }

        function render(data) {
            const { session, prizes, results, questions } = data;
            document.title = session.title + ' Results ‚Äî QuizPro Winner';

            document.getElementById('resultSub').textContent = session.title;

            const myResult = results.find(r => user && r.user_id == user.id);
            if (myResult) {
                document.getElementById('viewBreakdownBtn').style.display = 'block';
                document.getElementById('resultEmoji').textContent = myResult.rank === 1 ? 'ü•á' : myResult.rank === 2 ? 'ü•à' : myResult.rank === 3 ? 'ü•â' : 'üë§';
                document.getElementById('resultTitle').textContent = `Rank #${myResult.rank} ‚Äî Score: ${myResult.score}/${questions.length}`;

                // Setup Speed Breakdown Table
                const totalMs = myResult.total_ms || 0;
                document.getElementById('totalMs').textContent = (totalMs / 1000).toFixed(2) + ' seconds';
                document.getElementById('avgMs').textContent = ((totalMs / questions.length) / 1000).toFixed(2) + ' seconds';

                const tableBody = document.getElementById('breakdownBody');
                tableBody.innerHTML = questions.map((q, i) => {
                    const uAns = myResult.answers[q.id] || '‚Äî';
                    const isCorrect = String(uAns).toLowerCase() === String(q.correct).toLowerCase();
                    const time = myResult.timings[q.id] || 0;

                    // Highlight row for better visibility
                    const bgColor = isCorrect ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.03)';

                    return `
                        <tr style="border-bottom:1px solid var(--border); background:${bgColor};">
                            <td style="padding:10px 12px;">${i + 1}</td>
                            <td style="padding:10px 12px; font-weight:700; color:${isCorrect ? 'var(--green)' : 'var(--red)'};">
                                ${uAns ? uAns.toUpperCase() : 'EMPTY'}
                            </td>
                            <td style="padding:10px 12px;">
                                ${isCorrect ? '‚úÖ Correct' : `‚ùå (Sahi: ${q.correct.toUpperCase()})`}
                            </td>
                            <td style="padding:10px 12px; text-align:right; color:var(--blue); font-family:monospace; font-weight:600;">
                                ${(time / 1000).toFixed(2)}s
                            </td>
                        </tr>`;
                }).join('');
            }

            // Prize info - Full Top 10 Table
            const totalColl = session.total_collection || session.entry_fee * session.seats_booked;
            const platformCut = session.platform_cut || Math.floor(totalColl * 0.25);
            const myRank = myResult ? myResult.rank : null;
            const rankMedals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];

            document.getElementById('prizeInfo').innerHTML = `
              <div style="margin-bottom:16px;">
                <div style="display:flex; justify-content:center; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
                  <div class="stat-card"><div class="stat-num" style="color:var(--muted);">‚Çπ${totalColl.toLocaleString()}</div><div class="stat-lbl">Total Collection</div></div>
                  <div class="stat-card"><div class="stat-num" style="color:var(--green);">‚Çπ${session.prize_pool?.toLocaleString() || Math.floor(totalColl * 0.75).toLocaleString()}</div><div class="stat-lbl">üèÜ Prize Pool (75%)</div></div>
                  <div class="stat-card"><div class="stat-num" style="color:var(--blue);">‚Çπ${platformCut.toLocaleString()}</div><div class="stat-lbl">Platform (25%)</div></div>
                </div>
                <h4 style="margin-bottom:10px; font-size:.95rem;">üèÖ Top 10 Winners Prize Breakdown</h4>
                <table style="width:100%; border-collapse:collapse; font-size:.85rem;">
                  <thead><tr style="color:var(--muted); border-bottom:1px solid var(--border);">
                    <th style="text-align:left; padding:6px 8px;">Rank</th>
                    <th style="text-align:right; padding:6px 8px;">Prize</th>
                    <th style="text-align:right; padding:6px 8px;">% of Pool</th>
                  </tr></thead>
                  <tbody>
                    ${prizes.map((p, i) => {
                const isMe = myRank === p.rank;
                return `<tr style="border-bottom:1px solid var(--border); ${isMe ? 'background:rgba(14,165,233,.12); font-weight:700;' : ''}">
                        <td style="padding:7px 8px;">${rankMedals[i]} Rank ${p.rank} ${isMe ? '<span class="badge badge-blue" style="font-size:.65rem;">YOU</span>' : ''}</td>
                        <td style="text-align:right; padding:7px 8px; color:var(--gold); font-weight:700;">‚Çπ${p.amount.toLocaleString()}</td>
                        <td style="text-align:right; padding:7px 8px; color:var(--muted);">${p.pct}%</td>
                      </tr>`;
            }).join('')}
                  </tbody>
                </table>
                <p style="font-size:.72rem; color:var(--muted); margin-top:10px; text-align:center;">üí∏ Prize sent directly to winner's UPI/Bank. Platform earns ‚Çπ${platformCut.toLocaleString()} (25%).</p>
              </div>`;


            // Podium (top 3)
            const top3 = results.slice(0, 3);
            const order = [top3[1], top3[0], top3[2]].filter(Boolean);
            const cls = [{ c: 'p2', h: 'ü•à' }, { c: 'p1', h: 'ü•á' }, { c: 'p3', h: 'ü•â' }];
            const pRank = [2, 1, 3];
            if (results.length >= 1) {
                document.getElementById('podiumWrap').innerHTML = `<div class="podium">` + order.map((r, i) => `
          <div class="podium-item">
            <div class="podium-avatar">${cls[i].h}</div>
            <div class="podium-block ${cls[i].c}">
              <div>Rank #${pRank[i]}</div>
              <div style="font-size:1.1rem; margin:4px 0;">${r.score}/${questions.length}</div>
              <div class="podium-prize">‚Çπ${prizes[pRank[i] - 1]?.amount || 0}</div>
            </div>
            <div class="podium-name">${r.name || r.mobile}</div>
          </div>`).join('') + `</div>`;
            }

            // Full leaderboard
            const rankColors = ['#fbbf24', '#94a3b8', '#b45309'];
            document.getElementById('leaderboard').innerHTML = results.map((r, i) => {
                const isMine = user && r.user_id == user.id;
                const prize = prizes.find(p => p.rank === r.rank);
                return `<div class="result-row ${isMine ? 'mine' : ''}">
          <div class="rank-num" style="background:${rankColors[i] || 'rgba(255,255,255,.08)'}; color:${i < 3 ? '#000' : '#fff'};">${r.rank}</div>
          <div style="flex:1;">
            <div style="font-weight:600;">${r.name || r.mobile} ${isMine ? '<span class="badge badge-blue">You</span>' : ''}</div>
            <div class="score-info">Score: ${r.score}/${questions.length} &nbsp;|&nbsp; Time: ${r.total_ms?.toLocaleString()} ms</div>
          </div>
          ${prize ? `<div class="prize-badge">‚Çπ${prize.amount}</div>` : ''}
        </div>`;
            }).join('') || '<p style="color:var(--muted); text-align:center;">No results yet.</p>';
        }

        load();
        renderFooter();
    </script>
</body>

</html>